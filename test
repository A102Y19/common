def get_download_path():
    """Get the default downloads folder path based on OS."""
    return os.path.join(os.path.expanduser("~"), "Downloads")

def download_PAK_file(driver, file_name):
    print(f"‚¨áÔ∏è Searching for file: {file_name} to download...")

    try:
        # **Step 1: Find and click the file to open preview**
        file_element = WebDriverWait(driver, 20).until(
            EC.presence_of_element_located(
                (By.XPATH, f"//span[@role='gridcell' and contains(text(), '{file_name}')]")
            )
        )
        driver.execute_script("arguments[0].click();", file_element)
        print(f"‚úÖ File '{file_name}' selected, opening preview...")

        # Wait for the file preview to load
        WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.XPATH, "//i[contains(@class, 'fa-download')]"))
        )
        print("üîÑ File preview loaded...")

        # **Step 2: Click the Download button**
        download_button = driver.find_element(By.XPATH, "//i[contains(@class, 'fa-download')]")
        driver.execute_script("arguments[0].click();", download_button)

        print(f"‚úÖ File '{file_name}' download started!")

        # **Step 3: Confirm Download**
        download_path = get_download_path()  # Get OS-specific download folder
        download_file_path = os.path.join(download_path, file_name)
        timeout = 30  # Max wait time for download (adjust as needed)

        while timeout > 0:
            if os.path.exists(download_file_path):
                print(f"‚úÖ Download confirmed: '{file_name}' is in {download_path}")
                return True
            time.sleep(2)  # Wait before checking again
            timeout -= 2

        print(f"‚ùå Download failed: '{file_name}' not found in {download_path} after waiting.")
        return False

    except Exception as e:
        print(f"‚ùå Error: Unable to download file '{file_name}' - {e}")
        return False
