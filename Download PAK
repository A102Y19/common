import subprocess
import socket
import logging

# Setup logging
logging.basicConfig(level=logging.INFO)

def get_current_hostname():
    """ Get the current machine's hostname """
    return socket.gethostname()

def execute_task(server, task_name, user, password):
    """ Execute the scheduled task on the remote server """
    command = f'schtasks.exe /run /S {server} /U {user} /P {password} /tn {task_name}'
    result = subprocess.run(command, capture_output=True, text=True)
    if result.returncode == 0:
        logging.info(f"Successfully ran task {task_name} on {server}")
    else:
        logging.error(f"Failed to run task {task_name} on {server}: {result.stderr}")

def execute_local_task(task_name):
    """ Execute the task locally on the current host """
    command = f'schtasks.exe /run /tn {task_name}'
    result = subprocess.run(command, capture_output=True, text=True)
    if result.returncode == 0:
        logging.info(f"Successfully ran task {task_name} locally.")
    else:
        logging.error(f"Failed to run task {task_name} locally: {result.stderr}")

def main():
    current_host = get_current_hostname()
    logging.info(f"Current host is {current_host}")

    # Credentials and tasks
    user = "SA-ITS-APSOMINT-LAB"
    password = "Jnjtestuser_1"
    tasks = [
        "OMPDISPATCHER\\OMP_JNJ_MD_OMEGA_LAB",
        "OMP Dispatcher\\OMP_JNJ_MD_OMEGA_LAB_DSPAgent"
    ]
    
    # For the specific machine, run tasks locally
    if current_host == "AWSDMJNVAW0002":
        for task in tasks:
            execute_local_task(task)
    else:
        # For other machines, execute tasks remotely
        remote_servers = ["AWSDMJNVAW0001", "AWSDMJNVAW000D", "AWSDMJNVAW000E", "AWSDMJNVAW000H", "AWSDMJNVAW000M"]
        for server in remote_servers:
            for task in tasks:
                execute_task(server, task, user, password)

if __name__ == "__main__":
    main()
