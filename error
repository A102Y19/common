from pywinauto import Desktop
import time
import sys

def check_schema_pass_popup():
    print("Waiting for schema execution popup (no timeout)...")

    while True:
        try:
            windows = Desktop(backend="uia").windows()
            for w in windows:
                title = w.window_text()

                if "Information" in title:
                    try:
                        dlg = w.wrapper_object()
                        dlg.set_focus()

                        # Log popup title
                        print("Detected Popup Title:", title)

                        # Try reading message text inside popup
                        text_elems = dlg.descendants(control_type="Text")
                        message = " ".join([t.window_text() for t in text_elems])
                        print("Popup Message:", message)

                        # Close popup
                        try:
                            dlg.child_window(title="OK", control_type="Button").click_input()
                            print("Clicked OK on popup.")
                        except:
                            print("Could not click OK.")

                        # Match message content
                        if "successfully executed" in message.lower():
                            print("✅ Schema executed successfully.")
                            return True
                        elif "encountered an error" in message.lower():
                            print("❌ Schema execution failed.")
                            sys.exit("Terminating due to error in schema execution.")
                        else:
                            print("❓ Unrecognized popup message.")
                            return False
                    except Exception as e:
                        print("Popup found, but error handling it:", e)

        except Exception as e:
            print("Error accessing windows:", e)

        time.sleep(2)
