@echo off

:: 1) Create a timestamp for the log file
for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /value') do set datetime=%%I
set logfile=\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\log_%datetime:~0,4%-%datetime:~4,2%-%datetime:~6,2%_%datetime:~8,2%-%datetime:~10,2%-%datetime:~12,2%.txt

echo [INFO] Log file: %logfile%

:: 2) Run the first PowerShell script, capture its output in a temporary file
echo [INFO] Running Agent Monitoring script...
Start /b powershell -ExecutionPolicy Bypass -File "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\AgentMonitoring_Omega_LAB.ps1" > "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_output.txt" 2>&1
timeout /t 5 /nobreak >nul

:: 3) Append the first script's output to the main log file
type "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_output.txt" >> %logfile%

echo [INFO] Checking for 'offline'...

:: 4) Check if 'offline' is found in the output
findstr /i "OFFLINE" "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_output.txt" >nul
echo Error Level: %errorlevel%

if %errorlevel%==0 (
    :: 4a) Run the Python script for inactive agent handling
    echo [INFO] Agent Inactive script execution starting...
    echo [INFO] Agent Inactive script execution starting... >> %logfile%
    python "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\inactive_test.py" %1 >> "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_Inactive.txt" 2>&1
    type "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_Inactive.txt" >> %logfile%
    echo [INFO] Agent Inactive script execution completed.

    ping 127.0.0.1 -n 3 >nul
    del "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_Inactive.txt"

    :: 4b) Run the second PowerShell script to restart agent
    echo [INFO] Agent Start script Execution starting...
    echo [INFO] Agent Start script Execution starting... >> %logfile%
    python "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\OMEGA_LAB.py" %2 >> "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_omegalab.txt" 2>&1
    type "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_omegalab.txt" >> %logfile%
    echo Agent restart script executed successfully >> %logfile%

    ping 127.0.0.1 -n 3 >nul
    del "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_omegalab.txt"

) else (
    echo [INFO] No Agent is 'offline'. Exiting script. >> %logfile%
    ping 127.0.0.1 -n 3 >nul
    del "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_output.txt"
    goto :EOF
)

:: 5) Final cleanup
ping 127.0.0.1 -n 3 >nul
del "\\awsusdmjfsxn01.jnj.com\eth_get_dev_omp\OMP_JNJ_MD_OMEGA_LAB\OMPartners\development\dispatcher\bin\Automation\Agent\log\temp_output.txt"

pause
